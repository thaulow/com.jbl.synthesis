<div>
  <style>
    #jbl-configure .form-group {
      margin-bottom: 16px;
    }
    #jbl-configure label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      margin-bottom: 6px;
      opacity: 0.7;
    }
    #jbl-configure input,
    #jbl-configure select {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid rgba(150,150,150,0.3);
      border-radius: 8px;
      font-size: 15px;
      box-sizing: border-box;
      background: rgba(150,150,150,0.1);
      color: inherit;
    }
    #jbl-configure .hint {
      font-size: 11px;
      opacity: 0.5;
      margin-top: 4px;
    }
    #jbl-configure .error {
      color: #e74c3c;
      font-size: 13px;
      margin-top: 12px;
      display: none;
    }
    #jbl-configure .connecting {
      text-align: center;
      opacity: 0.6;
      font-size: 14px;
      padding: 12px;
      display: none;
    }
    #jbl-configure .button-container {
      margin-top: 24px;
    }
    #jbl-configure button {
      width: 100%;
      padding: 12px;
      background: #FF6900;
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
    }
    #jbl-configure button:disabled {
      background: #888;
      cursor: not-allowed;
    }
  </style>

  <div id="jbl-configure">
    <div class="form-group">
      <label>IP ADDRESS</label>
      <input type="text" id="jbl-ip" placeholder="192.168.1.100" autocomplete="off" />
      <p class="hint">IP address of the receiver or serial-to-IP bridge</p>
    </div>

    <div class="form-group">
      <label>TCP PORT</label>
      <input type="number" id="jbl-port" value="50000" min="1" max="65535" />
      <p class="hint">Default: 50000</p>
    </div>

    <div class="form-group">
      <label>MODEL</label>
      <select id="jbl-model">
        <option value="SDR-35">SDR-35</option>
        <option value="SDR-38" selected>SDR-38</option>
        <option value="SDP-55">SDP-55</option>
        <option value="SDP-58">SDP-58</option>
      </select>
    </div>

    <p class="error" id="jbl-error"></p>
    <p class="connecting" id="jbl-connecting">Connecting to receiver...</p>

    <div class="button-container">
      <button type="button" id="jbl-connect">Connect</button>
    </div>
  </div>
</div>

<script>
  (function() {
    function init(Homey) {
      Homey.ready();

      document.getElementById('jbl-connect').addEventListener('click', function() {
        var ip = document.getElementById('jbl-ip').value.trim();
        var port = parseInt(document.getElementById('jbl-port').value) || 50000;
        var model = document.getElementById('jbl-model').value;

        if (!ip) {
          showError('Please enter an IP address');
          return;
        }

        if (!/^(\d{1,3}\.){3}\d{1,3}$/.test(ip) && !/^[a-zA-Z0-9.\-]+$/.test(ip)) {
          showError('Please enter a valid IP address or hostname');
          return;
        }

        hideError();
        setLoading(true);

        Homey.emit('configure', { ip: ip, port: port, model: model }, function(err, result) {
          setLoading(false);
          if (err) {
            showError(err.message || 'Could not connect to receiver');
          } else {
            Homey.showView('list_devices');
          }
        });
      });
    }

    function showError(msg) {
      var el = document.getElementById('jbl-error');
      el.textContent = msg;
      el.style.display = 'block';
    }

    function hideError() {
      document.getElementById('jbl-error').style.display = 'none';
    }

    function setLoading(loading) {
      document.getElementById('jbl-connect').disabled = loading;
      document.getElementById('jbl-connecting').style.display = loading ? 'block' : 'none';
    }

    // Homey injects the API as a global. Try it directly, fall back to onHomeyReady, or poll.
    if (typeof Homey !== 'undefined') {
      init(Homey);
    } else {
      window.onHomeyReady = function(h) { init(h); };
      // Also poll in case neither method fires
      var poll = setInterval(function() {
        if (typeof Homey !== 'undefined') {
          clearInterval(poll);
          init(Homey);
        }
      }, 200);
    }
  })();
</script>
